<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
	</head>

	<body>
		<div class="tabContent">
			<table class="tabTable matrixTab">
				<tr>
					<th>员工基本信息</th>
					<td>员工工号：<span name="psnbase.psncode" id="employee_number"></span></td>
					<td>员工姓名：<span name="psnbase.psnname" id="employee_name"></span></td>
					<td>员工性别：<span name="psnbase.sex" id="employee_sex"></span></td>
				</tr>
				<tr>
					<th class="ZNYY ZNYB DSZN">子女情况：（选择报销子女姓名）</th>
					<th class="ZGQS">家属情况：（选择报销家属姓名）</th>
					<td id="hiPsnList">
					</td>
					<th class="ZNYY ZNYB DSZN">报销类别：(选择报销子女类型)</td>
					<th class="ZGQS">家属证号</td>
					<td class="ZNYY ZNYB DSZN">
						<select class="formInput" id="child_nature">
						</select>
					</td>
					<td class="ZGQS">
						<div>
							李华：12123123123123
						</div>
						<div>
							张建国：12123123123122
						</div>
					</td>
				</tr>
				<!--子女医药Start----------------->
				<tr class="ZNYY ZNYB ZGQS">
					<th>报销单据信息录入</th>
					<td><span class="ZNYY ZGQS">医疗费金额：</span> <span class="ZNYB">医保金额：</span><input type="number" class="formInput" id="reimbursement_money_all" style="width: 100px;" /> 元 </td>
					<td>附件张数：<input type="number" class="formInput" id="enclosure_num" style="width: 100px;" />张 </td>
					<td class="ZNYY ZGQS">发生日期：<input type="date" id="plcae_date" /></td>
					<td class="ZNYB">医保发票年：<input type="number" class="formInput" id="YBFP_year" style="width: 100px;"> 年 </td>
				</tr>
				<tr class="ZNYY ZGQS">
					<th>该员工本年度所有 </th>
					<td>本年度累计医药费用：<span name="total.count(reimbursement_money)"></span> 元</td>
					<td>本年度累报销金额：<span name="total.count(reimbursement_money_all)"></span>元</td>
				</tr>
				<tr class="ZNYY ZGQS">
					<th>该子女本年度所有 </th>
					<td>本年度累计医药费用：<span name="total.count(reimbursement_money)"></span>元</td>
					<td>本年度累报销金额：<span name="total.count(reimbursement_money_all)"></span>元</td>
				</tr>
				<!--子女医药end----------------->
				<!--独生子女Start----------------->
				<tr class="DSZN">
					<th>报销单据信息录入</th>
					<td colspan="3">
						报销月份：<input type="text" class="formInput" id="month" style="width: 100px;"/> 月 &nbsp;&nbsp;&nbsp;&nbsp;
						&nbsp;&nbsp;&nbsp;&nbsp; 附件张数：<input type="number" id="DSZN_enclosure_num" class="formInput" style="width: 100px;"/> 张 
					</td>
				</tr>
				<tr class="DSZN">
					<td colspan="2">本年度该子女已报销总额：<span name="total.count(reimbursement_money)"></span> 元</td>
					<td colspan="2">本年度该员工已报销总额：<span name="total.count(reimbursement_money_all)"></span> 元</td>
				</tr>
				<!--独生子女End----------------->
			</table>
		</div>
		<script>
		
			if(getInfoByXBType == 'ZNYY')
				$(".ZNYY").show()
			else if(getInfoByXBType == 'DSZN')
				$(".DSZN").show()
			else if(getInfoByXBType == 'ZNYB') {
				var date = new Date();
				$("#plcae_date").val(date.toDay())
				$(".ZNYB").show()
			}
			else if(getInfoByXBType == 'ZGQS')
				$(".ZGQS").show()
		
			var psnbaseData = {};
			//查询员工信息
			function getInfoByXB() {
				if($("#psncode").val() == '' || $("#psncode").val() == null) {
					tip("请输入员工号");
					return;
				};
				
				$.ajax({
					url: apphost() + "getInfoByXB",
					type: 'get',
					data: {
						psncode: $("#psncode").val(),
						type: getInfoByXBType
					},
					contentType: 'application/json;charset=utf-8',
					success: function(data) {
						console.log(data);
						if(!isRight(data)) return;
						//根据年份和性别判断
						var date = new Date();
						if(getInfoByXBType == 'ZGQS') {
							if((date.getFullYear() % 2 == 0 && data.result.sex == "男") || (date.getFullYear() % 2 != 0 && data.result.sex == "女") ){
								showFaceModel();
								return;
							}
							
						}else {
							if((date.getFullYear() % 2 == 0 && data.result.psnbase.sex == "男") || (date.getFullYear() % 2 != 0 && data.result.psnbase.sex == "女") ){
								showFaceModel();
								return;
							}
						}
						$(".allBaoxiao").show();
						//渲染
						toView(data,true);
						if(data.result.money.children != null) {
							templateData = {
								'status': 'succ',
								'result': {
									'children': data.result.money.children	
								}
							}
							toView(templateData,true)
						}
						
						
						
						$("#hiPsnList").children().remove();
						for(var i = 0; i < data.result.hiPsnList.length; i++) {
							curPsn = data.result.hiPsnList[i];
							var hiPsnListValue = curPsn.hipsnname + "/" + curPsn.sex + "/" + curPsn.birthday
							$("#hiPsnList").append(
							"<div>"
								+ "<input type='checkbox' name='hiPsnList' value='" + hiPsnListValue + "'/>"
								+ "<span>" + hiPsnListValue + "</span>"
							+ "</div>"
							)
						}
						psnbaseData = data.result.psnbase;
						//子女医药费的显示
						if(getInfoByXBType == 'ZNYY') {
							var DSZNData = {
								status: 'succ',
								result: {
									total: data.result.money.total
								}
							}
							toView(DSZNData)
						}
						//独生子女时的显示
						if(getInfoByXBType == 'DSZN') {
							var DSZNData = {
								status: 'succ',
								result: {
									record: data.result.money.tf_temp,
									total: data.result.money.total
								}
							}
							toView(DSZNData)
						}
						
					}
				})
			}
			
			//新增保险单据
			function makeBill() {
				if(getInfoByXBType == 'ZNYY')
					if(!isEmptyWithIds("reimbursement_money_all,enclosure_num,plcae_date")) return
				else if(getInfoByXBType == 'DSZN')
					if(!isEmptyWithIds("month,DSZN_enclosure_num")) return
				else if(getInfoByXBType == 'ZNYB')
					if(!isEmptyWithIds("reimbursement_money_all,enclosure_num,YBFP_year")) return
				else if(getInfoByXBType == 'ZGQS')
					if(!isEmptyWithIds()) return
				
				var employee_children = '';
				for(var i = 0; i < $("input[name='hiPsnList']:checked").length; i++) {
					/*employee_children = $("input[name='hiPsnList']:checked").eq(i).val() + "," + employee_children;*/
					employee_children = $("input[name='hiPsnList']:checked").eq(i).val().split("/")[0] + "," + employee_children;
				}
				if(employee_children != '') {
					employee_children = employee_children.substring(0, employee_children.length-1)
				}else {
					if(getInfoByXBType != 'ZGQS') {
						tip("请选择子女！");
						return;
					}else {
						tip("请选择亲属！");
						return;
					}
				}
				
				var enclosure_num
				if(getInfoByXBType == "DSZN") 
					enclosure_num = $("#DSZN_enclosure_num").val();
				else 
					enclosure_num = $("#enclosure_num").val();
				
				$.ajax({
					url: apphost() + "addBXD",
					type: 'post',
					data: JSON.stringify({
						employee_number: $("#employee_number").text(),
						employee_name: $("#employee_name").text(),
						employee_sex: $("#employee_sex").text(),
						employee_children: employee_children,
						reimbursement_type: $("#child_nature").val(),
						reimbursement_money_all: $("#reimbursement_money_all").val(),
						enclosure_num: enclosure_num,
						plcae_date: $("#plcae_date").val(),
						month: $("#month").val(),
						type: getInfoByXBType,
						YBFP_year: $("#YBFP_year").val()
					}),
					contentType: 'application/json;charset=utf-8',
					success: function(data) {
						if(!isRight(data)) return;
						var psnbaseStr = JSON.stringify(psnbaseData);
						var dataStr = JSON.stringify(data.result);
						employeeStr = psnbaseStr.substring(0, psnbaseStr.length-1) + "," + dataStr.substring(1, dataStr.length);
						
						var employee = {
							'status': 'succ',
							'result': {
								'employee': JSON.parse(employeeStr)
							}
						}
						$.cookie("employee", JSON.stringify(employee), {path: "createBill.html"})
						
						//location.href = "createBill.html";
					}
				})
			}
			
			function showFaceModel() {
				$(".modal, .modal-backdrop").css("display", "block");
			}
			
			//重置
			function reloadPage() {
				$("#baoxiao").load("/public/baoxiaoFrame.html");
				getAllChildren();
				getInfoByXB();
			}
		</script>
	</body>
</html>